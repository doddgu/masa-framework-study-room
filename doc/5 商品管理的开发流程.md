### 开发服务

#### 安装Docker Desktop

https://www.cnblogs.com/doddgu/p/dapr-learning-3.html

#### 安装Dapr

* 在线安装：
  
  https://www.cnblogs.com/doddgu/p/dapr-learning-3.html

* 离线安装：
  
  https://docs.dapr.io/operations/hosting/self-hosted/self-hosted-airgap/
  
  1. 下载Dapr Installer Bundle
     
     https://github.com/dapr/installer-bundle/releases/download/v1.9.0-rc.5/daprbundle_windows_amd64.zip
  
  2. 创建目录`C:\dapr`，并添加到 System PATH
  
  3. 执行命令：`dapr init --from-dir C:\dapr`
  
  4. 启动Redis（推荐）
     
     ```powershell
     docker run --name "dapr_redis" --restart always -d -p 6379:6379 redislabs/rejson
     ```
  
  5. 启动Zipkin（可选）
     
     ```powershell
     docker run --name "dapr_zipkin" --restart always -d -p 9411:9411 openzipkin/zipkin
     ```

#### 运行Dapr Sidecar

* 为项目`Masa.EShop.Services.Catalog`安装NuGet包`Masa.Utils.Development.Dapr.AspNetCore`
  
  ```powershell
  dotnet add package Masa.Utils.Development.Dapr.AspNetCore
  ```

* 在`Program.cs`中添加在Debug模式下才启动DaprStarter的代码
  
  ```csharp
  #if DEBUG
  
  builder.Services.AddDaprStarter();
  
  #endif
  ```

* 启动项目后检查Dapr Sidecar运行情况
  
  > **注意：** 要用administrator运行terminal
  
  ```powershell
  dapr list
  
  //结果如下
    APP ID                                    HTTP PORT  GRPC PORT  APP PORT  COMMAND  AGE  CREATED              DAPRD PID  CLI PID
    Masa-EShop-Services-Catalog-00FF22532E62  62629      62630      5290               3h   2022-10-10 11:10.29  14804      3242
  ```

添加Dapr Client

* 为项目`Masa.EShop.Web.Admin`安装NuGet包`Masa.Contrib.Service.Caller.DaprClient`
  
  ```powershell
  dotnet add package Masa.Contrib.Service.Caller.DaprClient
  ```

* 修改`Program.cs`中的代码，将原来AddCaller的HttpClient改为Dapr
  
  ```csharp
  builder.Services.AddCaller(options =>
  {
      options.UseDapr("CatalogCaller", clientBuilder =>
      {
          // AppId不需要加mac地址，因为caller会根据需要自动补充
          clientBuilder.AppId = "Masa-EShop-Services-Catalog";
      });
  });
  ```

* abc
